権限の出所

| 権限の出所                   | 説明                                                         |
| ----------------------- | ---------------------------------------------------------- |
| **1. ユーザーがログイン時**       | ユーザーが所属する部門のすべてのロール（ユーザー部門表 → 部門権限表 → ロール権限表）をダウンロードします。   |
| **2. 案件を開く時（または一覧表示時）** | 案件の「分類」と「状態」に基づき、ユーザーが持っているロールを使って【その案件】に対する許可された権限を抽出します。 |
| **3. 画面制御時（ボタンや操作など）**  | 現在の権限結果に基づいてUIを制御します（例：「更新」ボタンの表示／非表示、クリック可否など）。           |


推奨される権限判断構成（2種類の出所を統合）
| 権限の出所      | 説明                                    |
| ---------- | ------------------------------------- |
| 所属部門のロール権限 | 部門ロール表＋ロール権限表から取得されます。                |
| 担当者の個人権限   | 案件表中の担当者フィールドにより、基本権限（閲覧、更新など）を付与します。 |


✅ 使用する元データ表 ➡ 構造表

| 元データ表                   | 出所   | 用途                             | ダウンロード条件                 |
| ----------------------- | ---- | ------------------------------ | ------------------------ |
| ユーザー部門表（UserDepartment） | －    | ユーザーが所属する部門IDの一覧を特定する          | WHERE UserID = 現在のユーザーID |
| 部門ロール表（DepartmentRole）  | －    | その部門に紐づくロールIDを取得する             | 上記条件に従う                  |
| ロール権限表（RolePermission）  | －    | これらのロールが特定の分類＋状態で持つ権限を取得する     | 上記条件に従う                  |
| 案件分類状態表（CaseStatus）     | t100 | 状態名の変換を表示する（必須・任意）案件表に使用       | ALL                      |
| 担当者表（CaseManager）       | m520 | 担当者情報を直接ダウンロード、担当者ID、社員番号などを取得 | ALL                      |


| 権限制御箇所  | 権限判定      | 案件状態による制御の有無 | 案件分類による制御の有無 |
| ------- | --------- | ------------ | ------------ |
| 新規案件ボタン | 部門ロール     | 無し           | 第二層にあり       |
| 編集ボタン   | 部門ロール＋担当者 | 有り           | 有り           |
| 審査ボタン   | 部門ロール     | 有り           | 有り           |
| 案件一覧画面  | 部門ロール＋担当者 | 有り           | 有り           |
| 照会ボタン   | 部門ロール     | 有り           | 有り           |


|                           | 配置場所                  | 名称                    | 備考                                                                           |
| ------------------------- | --------------------- | --------------------- | ---------------------------------------------------------------------------- |
| データベース接続インターフェース          | インターフェース層             | IPermissionRepository |                                                                              |
| インターフェースの実装【課題：インターフェース化】 | データ層                  | CPermissionRepository | 実装クラスは、テスト時にフェイククラス（Mock）に差し替え可能にするためのもの。<br>FakeUserRepositoryなど 【Mockについて】 |
| ビジネスロジック                  | ビジネスロジック層             | SPermissionService    | 読み取り専用のため、データクラスは不要。                                                         |
| 画面からの呼び出し                 | フォーム層                 |                       |                                                                              |
| シングルトンクラス【シングルトンについて】※重要  | （インフラ層）Infrastructure | PermissionManager     |                                                                              |
